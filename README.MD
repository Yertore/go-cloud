Middleware — это функция, которая:

делает что-то ДО handler
делает что-то ПОСЛЕ handler


например:

Request
 ↓
middleware (log start)
 ↓
handler
 ↓
middleware (log latency)
 ↓
Response

Middleware — это просто wrapper:

func wrapper(handler) handler {
    return newHandler {
        before
        handler()
        after
    }
}

Это pattern называется: decorator pattern

Когда тебе надо “graceful shutdown”, ты всегда строишь это так:
Создать http.Server (а не ListenAndServe одной строкой)
Запустить сервер (обычно в горутине)
Подписаться на сигналы ОС (SIGINT, SIGTERM)
Дождаться сигнала
Вызвать Shutdown с таймаутом (например 5s)
(опционально) если не успел — Close (жёстко)
Это стандартный шаблон для продакшена.

1) Для чего нужен graceful shutdown?
Если ты просто убьёшь процесс (или контейнер), то:
запрос в середине обработки обрывается
клиент получает “connection reset”
возможна полузапись в БД, неконсистентность
если ты в Kubernetes — при деплое/скейле поды постоянно перезапускаются, и без graceful у тебя будут случайные ошибки.

SIGINT — когда ты нажал Ctrl+C в терминале
SIGTERM — “пожалуйста завершись” (Kubernetes/Unix обычно отправляет его при остановке)

Супер-короткая схема всего процесса:
Сервер запущен и обслуживает запросы
Приходит SIGTERM (например Kubernetes делает rolling update)
Твой код ловит сигнал
Shutdown(5s):
-новые запросы не принимает
-старые пытается завершить
Если успели — красиво завершились
Если нет — Close() обрубает



3) Как научиться писать Dockerfile самому (шаблон мышления)

Всегда думай так:

Шаг A: Что я делаю в контейнере?
-Build: нужен компилятор, зависимости, исходники
-Run: нужен только результат (бинарник)
=> значит multi-stage.

Шаг B: Что должно попасть в финальный образ?
Для Go:
-бинарник
-иногда ca-certificates (если делаешь HTTPS запросы)
-больше ничего

Шаг C: Как сделать финальный образ минимальным и безопасным?
-CGO_ENABLED=0 чтобы бинарник был максимально автономным
-distroless или alpine
-запускать non-root
-exec form

Шаг D: Как ускорить сборки?
-сначала COPY go.mod go.sum + go mod download
-потом COPY . .
-Если ты запомнишь эти 4 шага — ты сможешь писать Dockerfile на автомате.